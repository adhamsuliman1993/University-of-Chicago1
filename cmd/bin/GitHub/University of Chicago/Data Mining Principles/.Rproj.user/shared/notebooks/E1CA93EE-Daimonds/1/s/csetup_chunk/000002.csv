"0","#rm(list=ls())"
"0","knitr::opts_chunk$set(echo = TRUE)"
"0","if(!""pacman"" %in% rownames(installed.packages())) {"
"0","  install.packages(""pacman"")"
"0","}"
"0","pacman::p_load(tidyverse, faraway,corrplot, tinytex, zoo, knitr, rgl, relaimpo, MuMIn, broom,ggplot2, tidyr, fields, cluster, data.table, reshape2,poLCA, stats, copula, caret, GGally, psych,pROC,RODBC,data.table,scales,sqldf, magrittr, maps, mapdata, ggmap,lubridate,flexmix,rpart)"
"0","clustreg=function(dat,k,tries,sed,niter){"
"0","set.seed(sed)"
"0","dat=as.data.frame(dat)"
"0","rsq=rep(NA,niter)"
"0","res=list()"
"0","rsq.best=0"
"0","    for(l in 1:tries) {"
"0","	c = sample(1:k,nrow(dat),replace=TRUE)"
"0","	yhat=rep(NA,nrow(dat))"
"0","	for(i in 1:niter) {		"
"0","		resid=pred=matrix(0,nrow(dat),k)"
"0","		for(j in 1:k){	"
"0","			pred[,j]=predict(glm(dat[c==j,],family=""gaussian""),newdata=dat)		"
"0","			resid[,j] = (pred[,j]-dat[,1])^2"
"0","		}"
"0","	c = apply(resid,1,fun.index.rowmin)"
"0","	for(m in 1:nrow(dat)) {yhat[m]=pred[m,c[m]]}"
"0","	rsq[i] = cor(dat[,1],yhat)^2	"
"0","	#print(rsq[i])"
"0","	}"
"0","	"
"0","	if(rsq[niter] > rsq.best) {	"
"0","		rsq.best=rsq[niter]"
"0","		l.best=l"
"0","            c.best=c"
"0","		yhat.best=yhat"
"0","		}"
"0","    }"
"0","    for(i in k:1) res[[i]]=summary(lm(dat[c.best==i,]))"
"0","	"
"0","return(list(data=dat,nclust=k,tries=tries,seed=sed,rsq.best=rsq.best,number.loops=niter, Best.try=l.best,cluster=c.best,results=res))"
"0","}"
"0","fun.index.rowmin=function(x) {"
"0","    "
"0","    z=(1:length(x)) [x == min(x)]"
"0","    if(length(z) > 1) { z=sample(z,1)}"
"0","    return ( z ) }"
